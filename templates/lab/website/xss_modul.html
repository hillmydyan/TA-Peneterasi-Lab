{% extends "layout/base.html" %}

{% block title %}XSS (Cross-Site Scripting) - Web Penetration Lab{% endblock %}

{% block content %}
<div class="container mx-auto p-4">

    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">XSS (CROSS-SITE SCRIPTING)</h1>
        <p class="text-base-content/70 max-w-3xl mx-auto">
            Lab ini mensimulasikan dua fitur umum yang sering jadi target XSS: <b>Search (Reflected)</b> dan
            <b>Guestbook (Stored)</b>.
            (Lab ini aman untuk edukasi: input tidak dieksekusi sebagai script di browser Anda selain alert simulasi.)
        </p>
    </div>

    <!-- Attack Surface Column (Full Width because XSS has 2 parts) -->
    <div class="card bg-base-100 shadow-xl border border-base-200 mb-8">
        <div class="card-body">
            <div class="flex flex-wrap justify-between items-start mb-4 gap-4">
                <div>
                    <h2 class="card-title text-base-content/80 uppercase tracking-widest text-sm mb-1">Attack Surface
                    </h2>
                    <div class="badge badge-primary font-bold">{{ difficulty|upper }}</div>
                </div>

                <div class="flex flex-wrap gap-2 items-center">
                    <span class="font-bold text-sm opacity-70">DIFFICULTY:</span>
                    <form action="" method="GET" class="join">
                        <button type="submit" name="difficulty" value="easy"
                            class="btn btn-sm join-item {{ 'btn-active btn-primary' if difficulty == 'easy' else 'btn-outline' }}">Easy</button>
                        <button type="submit" name="difficulty" value="medium"
                            class="btn btn-sm join-item {{ 'btn-active btn-warning' if difficulty == 'medium' else 'btn-outline' }}">Medium</button>
                        <button type="submit" name="difficulty" value="hard"
                            class="btn btn-sm join-item {{ 'btn-active btn-success' if difficulty == 'hard' else 'btn-outline' }}">Hard</button>
                    </form>

                    <a href="{{ url_for('website.sql_injection') }}" class="btn btn-sm btn-ghost ml-2">
                        ← Back to SQLi
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-[100px_1fr] gap-4 text-sm font-mono mb-6">
                <div class="font-bold opacity-70 self-center">Reflected</div>
                <div><kbd class="kbd kbd-sm font-sans">/metadata-investigation?q=...</kbd></div>

                <div class="font-bold opacity-70 self-center">Stored</div>
                <div><kbd class="kbd kbd-sm font-sans">POST /metadata-investigation</kbd></div>

                <div class="font-bold opacity-70 self-center">Fields</div>
                <div class="flex gap-2">
                    <code class="bg-base-200 px-1 rounded">name</code>
                    <code class="bg-base-200 px-1 rounded">message</code>
                    <code class="bg-base-200 px-1 rounded">q</code>
                </div>
            </div>

            <!-- Legend (Behavior) -->
            <div class="bg-base-200 rounded p-4 text-xs space-y-2 opacity-80">
                <p class="font-bold mb-1">Behavior per level:</p>
                <p>• <b>Easy:</b> tampilkan "unsafe preview" sebagai teks untuk memahami dampak.</p>
                <p>• <b>Medium:</b> filtering naif (&lt; &gt; dihapus) + tetap escape output.</p>
                <p>• <b>Hard:</b> input dibatasi panjang + feedback lebih minimal.</p>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- PART 1: Reflected XSS -->
        <div class="card bg-base-100 shadow-xl border border-base-200 h-fit">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title text-base-content/80 uppercase tracking-widest text-sm">REFLECTED XSS</h2>
                    <span class="badge badge-error badge-outline font-poppins text-xs font-bold">SEARCH</span>
                </div>

                <form method="GET" class="form-control w-full mb-4">
                    <!-- Keep difficulty in query param -->
                    <input type="hidden" name="difficulty" value="{{ difficulty }}">

                    <label class="label pt-0">
                        <span class="label-text font-bold text-xs uppercase">Search Query (q)</span>
                    </label>
                    <div class="join w-full">
                        <input id="search-input" type="text" name="q" value="{{ q }}" placeholder="e.g. <script>..."
                            class="input input-bordered join-item w-full font-mono text-sm" />
                        <button type="submit" class="btn btn-primary join-item px-6">Send</button>
                    </div>
                </form>

                <div class="flex flex-wrap gap-2 mb-4">
                    <button type="button" onclick="document.getElementById('search-input').value='hello'"
                        class="btn btn-sm btn-outline btn-info rounded-full gap-2 hover:scale-105 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path
                                d="M10 2a.75.75 0 01.75.75v12.59l1.95-2.1a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 111.1-1.02l1.95 2.1V2.75A.75.75 0 0110 2z" />
                        </svg>
                        Fill Hello
                    </button>
                    <button type="button"
                        onclick="document.getElementById('search-input').value='<script>alert(1)</script>'"
                        class="btn btn-sm btn-outline btn-error rounded-full gap-2 hover:scale-105 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z"
                                clip-rule="evenodd" />
                        </svg>
                        Fill Attack
                    </button>
                </div>

                <div class="divider text-xs opacity-50 my-1">Server Response</div>

                <!-- Response Area (Dark Mode Terminal Style matching SQLi) -->
                <div
                    class="bg-neutral text-neutral-content rounded-lg p-4 min-h-[80px] font-mono text-sm break-all relative group">
                    <div class="absolute top-2 right-2 opacity-30 text-[10px] uppercase font-bold">Rendered Output</div>
                    {% if q %}
                    {% if difficulty in ['easy', 'medium'] %}
                    {{ reflected_output | safe }}
                    {% else %}
                    {{ reflected_output }}
                    {% endif %}
                    {% else %}
                    <span class="opacity-30 italic text-xs">Waiting for input...</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- PART 2: Stored XSS -->
        <div class="card bg-base-100 shadow-xl border border-base-200 h-fit">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title text-base-content/80 uppercase tracking-widest text-sm">STORED XSS</h2>
                    <span class="badge badge-secondary badge-outline font-poppins text-xs font-bold">GUESTBOOK</span>
                </div>

                {% if error %}
                <div class="alert alert-error shadow-sm text-sm py-2 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>{{ error }}</span>
                </div>
                {% endif %}

                <form method="POST" class="space-y-3 mb-4">
                    <div class="form-control">
                        <label class="label py-1"><span class="label-text font-bold text-xs uppercase">Your
                                Name</span></label>
                        <input type="text" name="name" placeholder="Name" required
                            class="input input-bordered input-sm w-full font-mono" />
                    </div>
                    <div class="form-control">
                        <label class="label py-1"><span
                                class="label-text font-bold text-xs uppercase">Message</span></label>
                        <textarea name="message" placeholder="Leave a message..." required
                            class="textarea textarea-bordered h-20 font-mono text-sm"></textarea>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <button type="submit" formaction="{{ url_for('website.reset_data') }}" formmethod="POST"
                            class="btn btn-xs btn-ghost text-error hover:bg-error/10">
                            Clear Entries
                        </button>
                        <button type="submit" class="btn btn-secondary btn-sm px-6">Sign Guestbook</button>
                    </div>
                </form>

                <div class="divider text-xs opacity-50">Recent Entries</div>

                <div class="space-y-3 max-h-[300px] overflow-y-auto pr-1">
                    {% if entries %}
                    {% for entry in entries %}
                    <div class="chat chat-start">
                        <div class="chat-header text-xs opacity-50 mb-1">
                            {% if difficulty in ['easy', 'medium'] %}
                            {{ entry['name'] | safe }}
                            {% else %}
                            {{ entry['name'] }}
                            {% endif %}
                            <time class="text-[10px] ml-1 opacity-70">{{ entry['created_at'][:10] }}</time>
                        </div>
                        <div class="chat-bubble chat-bubble-secondary break-words text-sm font-mono">
                            {% if difficulty in ['easy', 'medium'] %}
                            {{ entry['message'] | safe }}
                            {% else %}
                            {{ entry['message'] }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center opacity-30 text-sm py-4 italic">Guestbook is empty.</div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}